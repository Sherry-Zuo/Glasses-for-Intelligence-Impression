---
title: "Glasses For Letter Grade Impression"
subtitle: BA830 - Fall 2019
author: "team 7"
date: "12/13/2019"
output: pdf_document
---

**Team 7 Members:** Kunpeng Huang, Yoki Liu, Lyufan Pan, Yunlei Zhou, Jiayuan Zou, Sherry Zuo

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=1, digits=8)
```

Key Elements of Project Writeup
When you write up your project paper, there is no predefined format. However, these factors must be included:
a. Your causal question of interest.  
b. Your experimental design and what data you collected.  
c. Why you chose the experiment design.  
d. Summary statistics about the data.  
e. Treatment effects.  
f. Limitations of your study.  
Make sure the paper is well-written and that there are figures and tables that are easy to understand.

```{r}
library(data.table)
library(tidyverse)
library(lfe)
library(lubridate)
library(stargazer)
library(gridExtra)
library(naniar)
library(ggmap)
```

```{r}
smart <- fread("survey.csv")
```

```{r}
#skimr::skim(smart)
#View(smart)
dim(smart)
```

```{r}
head(smart, 2)
```

```{r}
smart=smart%>%select(-Status, -DistributionChannel, -RecipientEmail, -RecipientFirstName, -RecipientLastName, -ExternalReference, -UserLanguage)
```

```{r}
#only keep finished records
smart=smart%>%filter(Finished=="True")%>%filter(Progress==100)
```

```{r}
smart=smart%>%select(-Progress, -Finished)
```

```{r}
length(unique(smart$ResponseId))
length(unique(smart$IPAddress))
```

```{r}
#some people take more than once, we only want to keep each person once.
smart=smart%>%distinct(IPAddress, .keep_all = TRUE)
```

```{r}
# Add treatment/control dummy variable:
smart2 = smart %>% 
  mutate(Treatment = ifelse(`Q4.1_First Click`=="", FALSE, TRUE))

# Variable selection:
smart_cleaned = smart2 %>% 
  select(-c(`Q2.1_First Click`:`Q2.1_Click Count`, `Q3.1_First Click`:`Q3.1_Click Count`, 
            `Q4.1_First Click`:`Q4.1_Click Count`, Q48, IPAddress, StartDate, EndDate, ResponseId)) %>% 
  select(1:8, 
         class_baseline=Q2.3, personality_baseline=Q2.4, grade_baseline=Q2.5, 
         gender_p=Q5.1, class_p=Q5.2, personality_p=Q5.3, grade_p=Q5.4,
         everything())
```

```{r}
control = smart_cleaned %>% 
  filter(Treatment == F) %>% 
  select(-c(Q4.3, Q4.4, Q4.5), class=Q3.3, personality=Q3.4, grade=Q3.5)

treatment = smart_cleaned %>% 
  filter(Treatment == T) %>% 
  select(-c(Q3.3, Q3.4, Q3.5), class = Q4.3, personality=Q4.4, grade=Q4.5) 

data = rbind(control, treatment)
#write_csv(data, "data.csv")
```

```{r}
data2<-read.csv("data.csv", na.strings = c("", "NA"))
```
```{r}
data2 = na.omit(data2)
```
```{r}
#write_csv(data2, "cleaned_data.csv")
```
```{r}
dim(data2)
```

```{r}
# Convert GPA
data2$grade = ifelse(data2$grade == "A(3.75-4.0)", 9,
                     ifelse(data2$grade == "A-(3.5-3.75)", 8,
                            ifelse(data2$grade == "B+(3.25-3.5)", 7,
                                   ifelse(data2$grade == "B(3.0-3.25)", 6,
                                          ifelse(data2$grade == "B-(2.75-3.0)", 5,
                                                 ifelse(data2$grade == "C+(2.5-2.75)", 4,
                                                        ifelse(data2$grade == "C(2.25-2.5)", 3,
                                                               ifelse(data2$grade == "C-(2.0-2.25)", 2,
                                                                      ifelse(data2$grade == "Prefer not to say", NA, 1)
                                                               ))))))))
table(data2$grade)
```

```{r}
# Convert GPA_P
data2$grade_p = ifelse(data2$grade_p == "A(3.75-4.0)", 9,
                     ifelse(data2$grade_p == "A-(3.5-3.75)", 8,
                            ifelse(data2$grade_p == "B+(3.25-3.5)", 7,
                                   ifelse(data2$grade_p == "B(3.0-3.25)", 6,
                                          ifelse(data2$grade_p == "B-(2.75-3.0)", 5,
                                                 ifelse(data2$grade_p == "C+(2.5-2.75)", 4,
                                                        ifelse(data2$grade_p == "C(2.25-2.5)", 3,
                                                               ifelse(data2$grade_p == "C-(2.0-2.25)", 2,
                                                                      ifelse(data2$grade_p == "Prefer not to say", NA,
                                                                             1)))))))))
table(data2$grade_p)
```

```{r}
# Convert GPA_baseline
data2$grade_baseline = ifelse(data2$grade_baseline == "A(3.75-4.0)", 9,
                     ifelse(data2$grade_baseline == "A-(3.5-3.75)", 8,
                            ifelse(data2$grade_baseline == "B+(3.25-3.5)", 7,
                                   ifelse(data2$grade_baseline == "B(3.0-3.25)", 6,
                                          ifelse(data2$grade_baseline == "B-(2.75-3.0)", 5,
                                                 ifelse(data2$grade_baseline == "C+(2.5-2.75)", 4,
                                                        ifelse(data2$grade_baseline == "C(2.25-2.5)", 3,
                                                               ifelse(data2$grade_baseline == "C-(2.0-2.25)", 2,
                                                                      ifelse(data2$grade_baseline == "Prefer not to say", NA,
                                                                             1)))))))))
table(data2$grade_baseline)
```
```{r}
data2$gender_p = ifelse(data2$gender_p == "Male", 1,
                 ifelse(data2$gender_p == "Female", 0, NA))

table(data2$gender_p)
```

```{r}
data2$personality_baseline = ifelse(data2$personality_baseline == "Logical", 1,
                             ifelse(data2$personality_baseline == "Emotional", 0, NA))

table(data2$personality_baseline)
```

```{r}
data2$personality_p = ifelse(data2$personality_p == "Logical", 1,
                             ifelse(data2$personality_p == "Emotional", 0, NA))

table(data2$personality_p)
```

```{r}
data2$personality = ifelse(data2$personality == "Logical", 1,
                             ifelse(data2$personality == "Emotional", 0, NA))

table(data2$personality)
```

```{r}
#save final cleaned version of data
#write_csv(data2, "data2.csv")
```

```{r}
analysis<-fread("data2.csv")
```

```{r}
summary(analysis)
```

```{r}
names(analysis)
```

```{r}
ggplot(data=analysis, aes(x=factor(gender_p), fill=factor(grade)))+
  geom_bar()+
  labs(x="Gender", fill="Grade")+
  theme(panel.background = element_rect(fill="white"))
```

```{r message=FALSE}
qmplot(x = LocationLongitude, y = LocationLatitude, data = analysis, colour = 'blue', alpha=0.4,  size = 0.6, zoom=5) + 
  theme(legend.position="")
```

```{r}
analysis$class_baseline<-factor(analysis$class_baseline, levels=c("Freshman", "Sophomore", "Junior", "Senior", "Graduates", "PhD"))
p1<-ggplot(analysis, aes(x=class_baseline, fill=factor(gender_p)))+
  geom_bar()+
  theme(panel.background = element_rect(fill="white"))
analysis$class<-factor(analysis$class, levels=c("Freshman", "Sophomore", "Junior", "Senior", "Graduates", "PhD"))
p2<-ggplot(analysis, aes(x=class, fill=factor(gender_p)))+
  geom_bar()+
  theme(panel.background = element_rect(fill="white"))
analysis$class_p<-factor(analysis$class_p, levels=c("Freshman", "Sophomore", "Junior", "Senior", "Graduates", "PhD", "Other"))
p3<-ggplot(analysis, aes(x=class_p, fill=factor(gender_p)))+
  geom_bar()+
  theme(panel.background = element_rect(fill="white"))
grid.arrange(p1,p2,p3, nrow=3, ncol=1)
```

```{r}
with(analysis, table(gender_p, grade_p))
```
```{r}
male_grade<-analysis[gender_p==1, grade_p]
table(male_grade)
female_grade<-analysis[gender_p==0, grade_p]
table(female_grade)
t.test(male_grade, female_grade)
```
Since the p-value is 0.039604 which smaller than 0.05, so we reject the null hypothesis, so we have 95% confidence that the true difference in means is not equal to 0, so which means it's not 50/50 split by gender in each grade level, so the experiment didn't achieve its desired randomizaion.   

```{r}
summary(lm(grade~Treatment, data=analysis))
lowerci<-0.98829-1.96*0.16252
lowerci
upperci<-0.98829+1.96*0.16252
upperci
```
The ATE of treatment on grade is **0.98829**, the 95% confidence interval is **[0.6697508, 1.3068292]**. 

```{r}
#adding the variable grade_p as a covariate to increase the precision of our ATE estimate.
summary(lm(grade~Treatment+grade_baseline, data=analysis))
lowerci2<-0.982320-1.96*0.149994
lowerci2
upperci2<-0.982320+1.96*0.149994
upperci2
```
The ATE of treatment on grade is **0.982320**, the 95% confidence interval is **[0.68833176, 1.2763082]**. By comparison, the standard error is smaller than before, it's more precise, and since the p-value of grade_baseline is less than 0.05, so it's a statistically significant covariate.

```{r}
summary(lm(personality~Treatment, data=analysis))
lowerci3<-0.285456-1.96*0.058103
lowerci3
upperci3<-0.285456+1.96*0.058103
upperci3
```
The ATE of treatment on grade is **0.285456**, the 95% confidence interval is **[0.17157412, 0.39933788]**. 

```{r}
#adding the variable grade_p as a covariate to increase the precision of our ATE estimate.
summary(lm(personality~Treatment+personality_baseline, data=analysis))
lowerci4<-0.282145-1.96*0.058269
lowerci4
upperci4<-0.282145+1.96*0.058269
upperci4
```
The ATE of treatment on grade is **0.282145**, the 95% confidence interval is **[0.16793776, 0.39635224]**. By comparison, the standard error is larger than before, it does not achieve our goal of precise. Also, since the p-value of grade_baseline is 0.3924 which is larger than 0.05, so the grade_baseline is not statistically significant as a covariate.  

##Randomization Check
```{r}
summary(lm(grade_baseline~Treatment, analysis))
```
Since the p-value is 0.9251 which is larger than 0.05, the R-square is -0.0048823 which is too small, so we fail to reject the null hypothesis, thus we think the ATE is 0, so we have 95% confidence that the glasses treatment on grade taken before the experiment started does not have effect. So this results indicate that the validity of the study's conclusion is high.   
```{r}
summary(lm(personality_baseline~Treatment, analysis))
```
Since the p-value is 0.3449 which is larger than 0.05, the R-square is -0.00050879 which is too small, so we fail to reject the null hypothesis, thus we think the ATE is 0, so we have 95% confidence that the glasses treatment on personality taken before the experiment started does not have effect. So this results indicate that the validity of the study's conclusion is high.  
```{r}
summary(felm(grade~Treatment*grade_p*gender_p*personality_p, data=analysis))
```
```{r}
summary(felm(personality~Treatment*personality_p*gender_p, data=analysis))
```




###############################################################################
We have one optional question in the end of our survey to ask whether people can detect our purpose or not, and they can take a guess. 
```{r}
guess <- read_csv("glasses.csv")
```
```{r}
names(guess)
```
```{r}
names(guess)<-"purpose_guess"
```



